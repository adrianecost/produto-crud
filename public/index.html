<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Produtos | Sistema Avançado</title>
  <!-- Link para a fonte Roboto do Google Fonts  -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Adicionando a biblioteca Chart.js para os gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <style>
    :root {
      --primary: #1e3a8a;
      --primary-light: #3b82f6;
      --secondary: #f97316;
      --danger: #dc2626;
      --success: #10b981;
      --light: #f8fafc;
      --gray: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #f1f5f9;
      color: #1e293b;
      padding: 20px;
    }

    header {
      background-color: var(--primary);
      color: white;
      padding: 25px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    header h1 { font-size: 2rem; margin-bottom: 5px; font-weight: 700; }
    header p { color: #cbd5e1; font-weight: 300; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      padding: 25px;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      background-color: var(--primary-light); /* Cor padrão */
    }
    
    .stat-card.orange { background-color: var(--secondary); }
    .stat-card.green { background-color: var(--success); }
    .stat-card.primary { background-color: var(--primary); }

    .stat-card .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-top: 8px;
    }

    .stat-card .stat-label {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .card {
      background: white;
      box-shadow: var(--shadow);
      padding: 25px;
      margin-bottom: 25px;
    }

    .card-title {
      color: var(--primary);
      font-size: 1.4rem;
      font-weight: 500;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .toolbar-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .toolbar-group > * {
        flex-shrink: 0; /* Evita que os campos de filtro encolham muito */
    }

    input[type="text"], input[type="number"], select {
      padding: 10px 15px;
      border: 1px solid var(--border);
      font-size: 1rem;
      min-width: 150px;
    }
    
    .search-input {
        flex-grow: 1;
        min-width: 250px !important;
    }

    .btn {
      border: none;
      padding: 10px 18px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s ease;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary { background-color: var(--primary-light); }
    .btn-primary:hover { background-color: #2563eb; }

    .btn-outline {
      background-color: white;
      color: var(--gray);
      border: 1px solid var(--border);
    }
    .btn-outline:hover { background-color: #f3f4f6; }
    
    .btn-export { background-color: var(--success); }
    .btn-export:hover { background-color: #059669; }

    .btn-warning { background-color: #fbbf24; color: #1e293b; }
    .btn-danger { background-color: var(--danger); }

    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    thead {
      background-color: var(--primary);
      color: white;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th.sortable { cursor: pointer; }
    th.sortable:hover { background-color: #102a6b; }
    th.sortable span { margin-left: 5px; font-size: 0.7em; }

    tbody tr:hover { background-color: #f1f5f9; }

    tr.low-stock td {
      background-color: #fee2e2;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .empty-state {
      text-align: center;
      color: var(--gray);
      padding: 30px;
    }

    .form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }

    label {
      font-weight: 500;
      display: block;
      margin-bottom: 5px;
    }
    
    /* Layout dos Gráficos */
    .charts-container {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        flex-wrap: wrap;
        /* Ajuste para que apenas dois gráficos preencham o espaço */
        justify-content: space-around;
    }
    
    .chart-card {
        flex: 1;
        min-width: 300px;
        max-width: 49%; /* Limita a dois por linha */
    }
    
    /* Paginação */
    .pagination {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
        padding-top: 15px;
    }
    .pagination button {
        background-color: var(--primary-light);
        color: white;
        border: none;
        padding: 8px 15px;
        cursor: pointer;
    }
    .pagination button:disabled {
        background-color: var(--gray);
        cursor: not-allowed;
    }
    
    /* Tabela de Alertas */
    #alertsTable {
        background-color: #fff7ed; /* Fundo levemente alaranjado para alerta */
        border: 1px solid var(--secondary);
    }
    
    @media (max-width: 768px) {
      .stats { grid-template-columns: 1fr; }
      .actions { flex-direction: column; }
      .charts-container { flex-direction: column; }
      .chart-card { max-width: 100%; } /* Em mobile, ocupa toda a largura */
      .toolbar-group { justify-content: space-between; }
      .toolbar-group > * { width: 100%; }
      input[type="text"], input[type="number"], select { min-width: unset; width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Gestão de Produtos</h1>
    <p>Painel de Controle e Análise Avançada de Estoque</p>
  </header>

  <!-- Dashboard Analítico - Estatísticas -->
  <div class="stats">
    <div class="stat-card primary">
      <div class="stat-value" id="totalProducts">0</div>
      <div class="stat-label">TOTAL DE PRODUTOS</div>
    </div>
    <div class="stat-card primary">
      <div class="stat-value" id="totalValue">R$ 0,00</div>
      <div class="stat-label">VALOR TOTAL EM ESTOQUE</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-value" id="lowStock">0</div>
      <div class="stat-label">PRODUTOS COM ESTOQUE BAIXO (&lt;10)</div>
    </div>
    <div class="stat-card green">
      <div class="stat-value" id="avgPrice">R$ 0,00</div>
      <div class="stat-label">PREÇO MÉDIO DOS PRODUTOS</div>
    </div>
  </div>

  <!-- Dashboard Analítico - Gráficos -->
  <div class="charts-container">
    <div class="card chart-card">
        <h2 class="card-title">Distribuição por Faixa de Preço (Unidades)</h2>
        <div style="height: 280px;"><canvas id="doughnutChart"></canvas></div>
    </div>
    <div class="card chart-card">
        <h2 class="card-title">Top 5 Produtos Mais Caros (Preço Unitário)</h2>
        <div style="height: 280px;"><canvas id="barChart"></canvas></div>
    </div>
    <!-- O gráfico de linha foi removido conforme solicitado. -->
  </div>
  
  <!-- Tabela de Alertas (Itens Críticos) -->
  <div class="card">
    <h2 class="card-title">Tabela de Alertas: Estoque Crítico (< 10 unidades)</h2>
    <table id="alertsTable">
        <thead>
            <tr>
                <th>ID</th><th>Nome</th><th>Estoque</th><th>Preço</th>
            </tr>
        </thead>
        <tbody id="alertsTableBody">
            <tr><td colspan="4" style="text-align: center;">Nenhum alerta de estoque baixo no momento.</td></tr>
        </tbody>
    </table>
  </div>
  
  <!-- Lista de Produtos com Filtros, Ordenação e Paginação -->
  <div class="card">
    <h2 class="card-title">Lista de Produtos</h2>
    <div class="toolbar">
        <input type="text" id="searchInput" class="search-input" placeholder="Pesquisar por nome, descrição ou ID (Pesquisa Inteligente)" />
        <button class="btn btn-primary" id="applyFiltersBtn">APLICAR FILTROS</button>
        <button class="btn btn-outline" id="clearFiltersBtn">LIMPAR FILTROS</button>
        <button class="btn btn-export" id="exportBtn">EXPORTAR EXCEL (.xlsx)</button>
    </div>
    
    <div class="toolbar-group">
        <input type="number" id="priceMin" min="0" placeholder="Preço Mínimo" />
        <input type="number" id="priceMax" min="0" placeholder="Preço Máximo" />
        <!-- CORREÇÃO 2: Valor padrão da Qtd Mínima alterado para 0 -->
        <input type="number" id="quantityMin" min="0" placeholder="Qtd Mínima (ex: 5)" value="0" />
        <select id="sortField" style="min-width: 150px;">
            <option value="id">Ordenar por ID</option>
            <option value="nome">Ordenar por Nome</option>
            <option value="preco">Ordenar por Preço</option>
            <option value="quantidade">Ordenar por Quantidade</option>
        </select>
        <select id="sortDirection">
            <option value="asc">Crescente (ASC)</option>
            <option value="desc">Decrescente (DESC)</option>
        </select>
    </div>

    <table>
      <thead>
        <tr>
          <th class="sortable" data-field="id">ID <span id="sort-id"></span></th>
          <th class="sortable" data-field="nome">Nome <span id="sort-nome"></span></th>
          <th>Descrição</th>
          <th class="sortable" data-field="preco">Preço <span id="sort-preco"></span></th>
          <th class="sortable" data-field="quantidade">Estoque <span id="sort-quantidade"></span></th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="productsTableBody"></tbody>
    </table>
    
    <div class="pagination">
        <button id="prevPageBtn" disabled>Página Anterior</button>
        <span id="pageInfo">Página 1 de 1</span>
        <button id="nextPageBtn" disabled>Próxima Página</button>
    </div>
  </div>

  <!-- Formulário de Criação -->
  <div class="card">
    <h2 class="card-title">Adicionar Novo Produto</h2>
    <form id="createForm">
      <div class="form-row">
        <div style="flex:1;">
          <label>Nome</label>
          <input type="text" id="nome" required />
        </div>
        <div style="flex:1;">
          <label>Preço (R$)</label>
          <input type="number" id="preco" step="0.01" min="0" required />
        </div>
      </div>
      <div class="form-row">
        <div style="flex:1;">
          <label>Descrição</label>
          <input type="text" id="descricao" />
        </div>
        <div style="flex:1;">
          <label>Quantidade</label>
          <input type="number" id="quantidade" min="0" required />
        </div>
      </div>
      <button type="submit" class="btn btn-primary">ADICIONAR PRODUTO</button>
    </form>
  </div>

  <script>
    // Variáveis de Elementos (Declaradas com 'let' para serem atribuídas após o DOM carregar)
    let productsTableBody, searchInput, applyFiltersBtn, clearFiltersBtn, exportBtn, createForm, 
        totalProductsEl, totalValueEl, lowStockEl, avgPriceEl, emptyState, alertsTableBody, 
        priceMinInput, priceMaxInput, quantityMinInput, sortFieldSelect, sortDirectionSelect,
        prevPageBtn, nextPageBtn, pageInfoEl;

    // Variáveis de Estado
    let products = [];
    let filteredProducts = [];
    let doughnutChartInstance;
    let barChartInstance;
    // lineChartInstance removido
    const itemsPerPage = 10;
    let currentPage = 1;
    let currentSort = { field: 'id', direction: 'asc' };

    // --- UTILS ---
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }

    // --- GRÁFICOS E ESTATÍSTICAS ---
    function updateStats() {
      totalProductsEl.textContent = products.length;
      
      const totalValueCalc = products.reduce((a, p) => a + p.preco * p.quantidade, 0);
      totalValueEl.textContent = formatCurrency(totalValueCalc);
      
      const lowStockCount = products.filter(p => p.quantidade < 10).length;
      lowStockEl.textContent = lowStockCount;
      
      const totalPrices = products.reduce((a, p) => a + p.preco, 0);
      const avgPrice = products.length > 0 ? totalPrices / products.length : 0;
      avgPriceEl.textContent = formatCurrency(avgPrice);

      updateCharts(); 
      // updateLineChart removido
      renderAlertsTable();
    }
    
    function updateCharts() {
        // 1. Gráfico de Rosca (Distribuição por Faixa de Preço)
        const priceRanges = {
            'Baixo (R$0-100)': products.filter(p => p.preco > 0 && p.preco <= 100).reduce((sum, p) => sum + p.quantidade, 0),
            'Médio (R$101-1000)': products.filter(p => p.preco > 100 && p.preco <= 1000).reduce((sum, p) => sum + p.quantidade, 0),
            'Alto (R$1000+)': products.filter(p => p.preco > 1000).reduce((sum, p) => sum + p.quantidade, 0),
        };
        
        const doughnutData = {
            labels: Object.keys(priceRanges),
            datasets: [{
                data: Object.values(priceRanges),
                backgroundColor: ['#10b981', '#3b82f6', '#1e3a8a'], // verde, azul claro, azul escuro
                hoverOffset: 4
            }]
        };

        if (doughnutChartInstance) {
            doughnutChartInstance.data = doughnutData;
            doughnutChartInstance.update();
        } else {
            doughnutChartInstance = new Chart(document.getElementById('doughnutChart'), {
                type: 'doughnut',
                data: doughnutData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
        
        // 2. Gráfico de Barras (Top 5 Produtos Mais Caros)
        const top5 = [...products]
            .sort((a, b) => b.preco - a.preco)
            .slice(0, 5);
            
        const barData = {
            labels: top5.map(p => p.nome),
            datasets: [{
                label: 'Preço Unitário (R$)',
                data: top5.map(p => p.preco),
                backgroundColor: ['#1e3a8a', '#3b82f6', '#0070b8', '#38bdf8', '#5bb8e0'],
            }]
        };

        if (barChartInstance) {
            barChartInstance.data = barData;
            barChartInstance.update();
        } else {
            barChartInstance = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: barData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => formatCurrency(value).replace('R$', '') } } }
                }
            });
        }
    }

    // A função updateLineChart foi removida

    function renderAlertsTable() {
        const lowStockItems = products.filter(p => p.quantidade < 10).sort((a, b) => a.quantidade - b.quantidade);
        
        if (lowStockItems.length === 0) {
            alertsTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum alerta de estoque baixo no momento.</td></tr>`;
            return;
        }

        alertsTableBody.innerHTML = lowStockItems.map(p => `
            <tr>
                <td>${p.id}</td>
                <td>${p.nome}</td>
                <td>${p.quantidade} unidades</td>
                <td>${formatCurrency(p.preco)}</td>
            </tr>
        `).join('');
    }

    // --- CRUD e FILTRAGEM (Simulando API RESTful) ---

    // 1. Aplica todos os filtros e ordenação
    function applyFiltersAndSort(data) {
        let result = [...data];
        
        // Captura os filtros atuais
        const currentFilters = { 
            search: searchInput.value.toLowerCase().trim(),
            priceMin: parseFloat(priceMinInput.value) || null,
            priceMax: parseFloat(priceMaxInput.value) || null,
            // CORREÇÃO 2: Pega o valor do input, que agora tem 0 como padrão
            quantityMin: parseInt(quantityMinInput.value) || 0
        };

        // FILTRAGEM
        result = result.filter(p => {
            // CORREÇÃO 1: Adiciona a verificação de ID na pesquisa inteligente
            const matchesSearch = currentFilters.search === '' || 
                p.nome.toLowerCase().includes(currentFilters.search) || 
                (p.descricao && p.descricao.toLowerCase().includes(currentFilters.search)) ||
                String(p.id).includes(currentFilters.search); // Adicionando busca por ID (convertendo para string)
                
            const matchesPriceMin = currentFilters.priceMin === null || p.preco >= currentFilters.priceMin;
            const matchesPriceMax = currentFilters.priceMax === null || p.preco <= currentFilters.priceMax;
            const matchesQuantityMin = p.quantidade >= currentFilters.quantityMin;

            return matchesSearch && matchesPriceMin && matchesPriceMax && matchesQuantityMin;
        });

        // ORDENAÇÃO
        const sortField = sortFieldSelect.value;
        const sortDirection = sortDirectionSelect.value;
        
        result.sort((a, b) => {
            const fieldA = a[sortField];
            const fieldB = b[sortField];
            
            let comparison = 0;
            if (fieldA > fieldB) { comparison = 1; }
            else if (fieldA < fieldB) { comparison = -1; }
            
            return sortDirection === 'asc' ? comparison : comparison * -1;
        });
        
        // Atualiza o estado global dos produtos filtrados
        filteredProducts = result;
        
        // Reinicia para a primeira página após filtrar/ordenar
        currentPage = 1;
        
        // Renderiza a tabela e a paginação
        renderProducts();
        renderPagination();
    }
    
    // 2. Renderiza a tabela da página atual
    function renderProducts() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const productsOnPage = filteredProducts.slice(startIndex, endIndex);

        if (filteredProducts.length === 0) {
            productsTableBody.innerHTML = '';
            // Não há elemento emptyState no HTML, mas mantive a verificação para evitar o erro original
            if (emptyState) { 
                emptyState.style.display = 'block';
            }
            return;
        }
        if (emptyState) { 
            emptyState.style.display = 'none';
        }
        
        productsTableBody.innerHTML = productsOnPage.map(p => `
            <tr class="${p.quantidade < 10 ? 'low-stock' : ''}">
                <td>${p.id}</td>
                <td>${p.nome}</td>
                <td>${p.descricao || '-'}</td>
                <td>${formatCurrency(p.preco)}</td>
                <td>${p.quantidade}</td>
                <td class="actions">
                    <button class="btn btn-warning btn-sm" onclick="editProduct(${p.id})">EDITAR</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">EXCLUIR</button>
                </td>
            </tr>
        `).join('');
    }
    
    // 3. Paginação
    function renderPagination() {
        const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
        
        pageInfoEl.textContent = `Página ${currentPage} de ${totalPages || 1}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || filteredProducts.length === 0;
    }
    
    function changePage(delta) {
        const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderProducts();
            renderPagination();
        }
    }
    
    // 4. Carregamento Inicial dos Dados (Função de simulação de API)
    async function loadInitialData() {
      // Dados iniciais de exemplo realistas para testes
      if (products.length === 0) {
        products = [
            { id: 101, nome: 'Monitor LED 27"', descricao: 'Monitor para jogos 144Hz, 1ms', preco: 1850.00, quantidade: 8, vendas: 250 },
            { id: 102, nome: 'Teclado Mecânico RGB', descricao: 'Switch Brown, Layout ABNT2', preco: 420.50, quantidade: 35, vendas: 500 },
            { id: 103, nome: 'Mouse Óptico Sem Fio', descricao: 'Ergonômico, 12000 DPI', preco: 159.90, quantidade: 150, vendas: 900 },
            { id: 104, nome: 'Webcam HD 1080p', descricao: 'Com microfone embutido', preco: 210.00, quantidade: 5, vendas: 120 },
            { id: 105, nome: 'Cabo HDMI 2.1 (2m)', descricao: 'Suporte a 8K@60Hz', preco: 85.90, quantidade: 250, vendas: 1200 },
            { id: 106, nome: 'SSD NVMe 1TB', descricao: 'Leitura 7000MB/s', preco: 599.99, quantidade: 12, vendas: 300 },
            { id: 107, nome: 'Headset Gamer USB', descricao: 'Som surround 7.1', preco: 380.00, quantidade: 45, vendas: 450 }
        ];
      }
      updateStats(); // Atualiza estatísticas, gráficos e alertas
      applyFiltersAndSort(products); // Renderiza a primeira página com ordenação e filtros padrão
    }
    
    // 5. Criação (Com Validação de String Negativa)
    function createProduct(data) {
        const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 101;
        // Adiciona 0 vendas para novos produtos
        const newP = { id: newId, vendas: 0, ...data }; 
        products.push(newP);
        
        updateStats(); 
        applyFiltersAndSort(products);
        createForm.reset();
    }

    // 6. Exclusão
    function deleteProduct(id) {
        // Nota: O uso de confirm() é para simulação rápida; em produção, use modais customizados.
        if (!confirm('Deseja EXCLUIR este produto? Esta ação não pode ser desfeita.')) return;
        products = products.filter(p => p.id !== id);
        
        // Garante que a atualização de todo o estado seja feita após a exclusão.
        updateStats(); 
        applyFiltersAndSort(products);
    }

    // 7. Edição (Com Validação Completa)
    async function editProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;

        let novoNome = prompt("Novo nome (não pode ser vazio):", product.nome);
        while (!novoNome || novoNome.trim() === "") {
            // Nota: O uso de alert() e prompt() é para simulação rápida; em produção, use modais customizados.
            alert("ERRO: O nome do produto não pode ser vazio."); 
            novoNome = prompt("Novo nome (não pode ser vazio):", product.nome);
            if (novoNome === null) return; 
        }

        const novaDescricao = prompt("Nova descrição:", product.descricao);

        // --- VALIDAÇÃO DE PREÇO (Inclusão de verificação de sinal negativo no string) ---
        let novoPrecoStr = prompt("Novo preço (R$ - deve ser positivo ou zero):", product.preco);
        let novoPreco = parseFloat(novoPrecoStr);
        // Verifica se é NaN, se é menor que zero, OU se a string de entrada original começa com '-' (para rejeitar -0 e outros negativos)
        while (isNaN(novoPreco) || novoPreco < 0 || (novoPrecoStr && novoPrecoStr.trim().startsWith('-'))) {
            alert("ERRO: Preço inválido. Por favor, insira um valor numérico positivo ou zero. Não utilize o sinal de negativo ('-').");
            novoPrecoStr = prompt("Novo preço (R$ - deve ser positivo ou zero):", product.preco);
            if (novoPrecoStr === null) return; 
            novoPreco = parseFloat(novoPrecoStr);
        }

        // --- VALIDAÇÃO DE QUANTIDADE (Inclusão de verificação de sinal negativo no string) ---
        let novaQtdStr = prompt("Nova quantidade (deve ser positiva ou zero):", product.quantidade);
        let novaQtd = parseInt(novaQtdStr);
        // Verifica se é NaN, se é menor que zero, OU se a string de entrada original começa com '-' (para rejeitar -0 e outros negativos)
        while (isNaN(novaQtd) || novaQtd < 0 || (novaQtdStr && novaQtdStr.trim().startsWith('-'))) {
            alert("ERRO: Quantidade inválida. Por favor, insira um número inteiro positivo ou zero. Não utilize o sinal de negativo ('-').");
            novaQtdStr = prompt("Nova quantidade (deve ser positiva ou zero):", product.quantidade);
            if (novaQtdStr === null) return; 
            novaQtd = parseInt(novaQtdStr);
        }
        
        // O campo 'vendas' não é editável aqui, mas deve ser mantido
        const updated = { 
            nome: novoNome, 
            descricao: novaDescricao, 
            preco: novoPreco, 
            quantidade: novaQtd,
            vendas: product.vendas // Mantém o valor de vendas
        };
        
        const index = products.findIndex(p => p.id === id);
        if (index !== -1) {
            products[index] = { ...products[index], ...updated };
        }

        updateStats(); 
        applyFiltersAndSort(products);
    }
    
    // 8. Exportação para Excel (.xlsx - Simulação CSV)
    function exportToExcel() {
        if (filteredProducts.length === 0) {
            // Em um ambiente de produção real, use um modal ou div de notificação
            alert("Não há dados para exportar. Aplique filtros ou adicione produtos."); 
            return;
        }

        const header = ["ID", "Nome", "Descricao", "Preco", "Quantidade", "Vendas", "Valor Total"];
        const rows = filteredProducts.map(p => [
            p.id,
            `"${p.nome.replace(/"/g, '""')}"`,
            `"${p.descricao.replace(/"/g, '""')}"`,
            p.preco.toFixed(2).replace('.', ','),
            p.quantidade,
            p.vendas, // Inclui o campo de vendas
            (p.preco * p.quantidade).toFixed(2).replace('.', ',')
        ]);

        const csvContent = "data:text/csv;charset=utf-8," 
            + header.join(";") + "\n" 
            + rows.map(e => e.join(";")).join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "produtos_estoque.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- FUNÇÃO DE INICIALIZAÇÃO E ATRIBUIÇÃO DOS ELEMENTOS ---
    function initApp() {
        // Atribuição de todos os seletores de elementos (agora que o DOM está pronto)
        productsTableBody = document.getElementById('productsTableBody');
        searchInput = document.getElementById('searchInput');
        applyFiltersBtn = document.getElementById('applyFiltersBtn');
        clearFiltersBtn = document.getElementById('clearFiltersBtn');
        exportBtn = document.getElementById('exportBtn');
        createForm = document.getElementById('createForm');
        totalProductsEl = document.getElementById('totalProducts');
        totalValueEl = document.getElementById('totalValue');
        lowStockEl = document.getElementById('lowStock');
        avgPriceEl = document.getElementById('avgPrice');
        //emptyState = document.getElementById('emptyState'); 
        alertsTableBody = document.getElementById('alertsTableBody');
        
        priceMinInput = document.getElementById('priceMin');
        priceMaxInput = document.getElementById('priceMax');
        quantityMinInput = document.getElementById('quantityMin');
        sortFieldSelect = document.getElementById('sortField');
        sortDirectionSelect = document.getElementById('sortDirection');
        
        prevPageBtn = document.getElementById('prevPageBtn');
        nextPageBtn = document.getElementById('nextPageBtn');
        pageInfoEl = document.getElementById('pageInfo');

        // Configuração dos Listeners de Eventos
        applyFiltersBtn.addEventListener('click', () => applyFiltersAndSort(products));
        clearFiltersBtn.addEventListener('click', () => { 
            searchInput.value = '';
            priceMinInput.value = '';
            priceMaxInput.value = '';
            quantityMinInput.value = 0; // CORREÇÃO 2: Limpando para o novo padrão 0
            sortFieldSelect.value = 'id';
            sortDirectionSelect.value = 'asc';
            applyFiltersAndSort(products);
        });
        
        sortFieldSelect.addEventListener('change', () => applyFiltersAndSort(products));
        sortDirectionSelect.addEventListener('change', () => applyFiltersAndSort(products));
        
        createForm.addEventListener('submit', e => {
          e.preventDefault();
          
          const precoEl = document.getElementById('preco');
          const quantidadeEl = document.getElementById('quantidade');
          
          const precoStr = precoEl.value.trim();
          const quantidadeStr = quantidadeEl.value.trim();
          
          // NOVO: Validação para impedir a criação com "-0" ou qualquer valor negativo
          if (precoStr.startsWith('-') || quantidadeStr.startsWith('-')) {
              // Nota: O uso de alert() é para simulação rápida; em produção, use modais customizados.
              alert("ERRO: Preço e Quantidade devem ser valores positivos ou zero. Não é permitido o uso do sinal de negativo ('-').");
              return; // Bloqueia a criação do produto
          }

          createProduct({
            nome: document.getElementById('nome').value,
            descricao: document.getElementById('descricao').value,
            preco: parseFloat(precoStr),
            quantidade: parseInt(quantidadeStr)
          });
        });

        prevPageBtn.addEventListener('click', () => changePage(-1));
        nextPageBtn.addEventListener('click', () => changePage(1));
        exportBtn.addEventListener('click', exportToExcel);
        
        // Carrega os dados iniciais após a inicialização do DOM e dos Listeners
        loadInitialData();
    }

    // Inicialização da Aplicação
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>